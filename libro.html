<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Estos meta tags se actualizar√°n din√°micamente -->
    <title>Cargando... - El Rinc√≥n del Lector</title>
    <meta name="description" content="Explora nuestra colecci√≥n de libros de segunda mano">
    
    <!-- Open Graph para Facebook -->
    <meta property="og:type" content="book">
    <meta property="og:site_name" content="El Rinc√≥n del Lector">
    <meta property="og:title" content="El Rinc√≥n del Lector">
    <meta property="og:description" content="Libros de segunda mano">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="El Rinc√≥n del Lector">
    <meta name="twitter:description" content="Libros de segunda mano">
    <meta name="twitter:image" content="">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* Estilos espec√≠ficos para la p√°gina de libro individual */
        .book-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .book-page-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .book-page-header .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .book-page-header h1 {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            margin: 0;
        }
        
        .back-to-store {
            background-color: white;
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .back-to-store:hover {
            background-color: var(--secondary-color);
        }
        
        .book-page-content {
            flex-grow: 1;
            padding: 2rem 1rem;
        }
        
        .loading-message {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error-message {
            text-align: center;
            padding: 3rem;
            color: var(--error-color);
        }
        
        .book-detail-wrapper {
            max-width: 1000px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="book-page">
    <header class="book-page-header">
        <div class="container">
            <h1>El Rinc√≥n del Lector</h1>
            <a href="index.html" class="back-to-store">‚Üê Volver a la tienda</a>
        </div>
    </header>

    <main class="book-page-content">
        <div id="book-container" class="book-detail-wrapper">
            <div class="loading-message">Cargando libro...</div>
        </div>
    </main>

    <footer class="main-footer">
        <p>&copy; 2023 El Rinc√≥n del Lector. Todos los derechos reservados.</p>
    </footer>

    <!-- Modal para la imagen -->
    <div id="image-modal" class="modal-overlay">
        <button class="modal-close">&times;</button>
        <div class="modal-content">
            <img src="" alt="Portada del libro ampliada" class="modal-image">
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        (function() {
            const BASE_PATH = window.BASE_PATH || '';
            const PLACEHOLDER_IMAGE = `${BASE_PATH}/images/placeholder.jpg`;
            
            // Obtener el ID del libro desde la URL
            function getBookIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }
            
            // Cargar los libros
            async function fetchBooks() {
                try {
                    const response = await fetch(`${BASE_PATH}/books.json`);
                    if (!response.ok) throw new Error('Error al cargar libros');
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    return null;
                }
            }
            
            // Generar HTML del precio
            function generatePriceHTML(book) {
                const hasDiscount = book.discountPrice && book.discountPrice < book.price;
                const priceFormatter = new Intl.NumberFormat('es-CO', { 
                    style: 'currency', 
                    currency: 'COP', 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
                const originalPrice = priceFormatter.format(book.price);
                const currentPrice = hasDiscount ? priceFormatter.format(book.discountPrice) : originalPrice;
                return `<div class="price-container">${hasDiscount ? `<span class="price-original">${originalPrice}</span><span class="price-current">${currentPrice}</span>` : `<span class="price-current">${currentPrice}</span>`}${book.promoTag ? `<span class="promo-tag">${book.promoTag}</span>` : ''}</div>`;
            }
            
            // Generar HTML del detalle del libro
            function generateBookDetailHTML(book) {
                const statusClass = book.status === 'available' ? 'status-badge--available' : 'status-badge--sold';
                const statusText = book.status === 'available' ? 'Disponible' : 'Vendido';
                const imageSrc = book.imageFile ? `${BASE_PATH}/images/${book.imageFile}` : PLACEHOLDER_IMAGE;
                
                return `
                    <div class="book-detail-content">
                        <img src="${imageSrc}" alt="Portada de ${book.title}" class="book-detail__cover" id="book-cover">
                        <div class="book-detail__info">
                            <h2 class="book-detail__title">${book.title}</h2>
                            <h3 class="book-detail__author">por ${book.author}</h3>
                            <ul class="book-detail__meta-list">
                                <li><strong>ISBN:</strong> ${book.isbn}</li>
                                <li><strong>Colecci√≥n:</strong> ${book.collection}</li>
                                <li><strong>G√©nero:</strong> ${book.genre}</li>
                                <li><strong>Estado:</strong> ${book.condition}</li>
                            </ul>
                            <p class="book-detail__description">${book.description}</p>
                            <div class="book-detail__footer">
                                <div class="book-detail__price">${generatePriceHTML(book)}</div>
                                <div class="book-detail__actions">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                    <div class="share-buttons">
                                        <button class="share-button share-button--copy" id="copy-link-btn" title="Copiar enlace">üìã Copiar Link</button>
                                        <button class="share-button share-button--facebook" id="share-facebook-btn" title="Compartir en Facebook">üìò Facebook</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Actualizar metadatos
            function updateMetaTags(book) {
                const currentUrl = window.location.href;
                const baseImageUrl = `${window.location.origin}${window.location.pathname.replace(/\/[^/]*$/, '')}${BASE_PATH}`;
                const imageSrc = book.imageFile 
                    ? `${baseImageUrl}/images/${book.imageFile}`
                    : `${baseImageUrl}/images/placeholder.jpg`;
                
                const priceFormatter = new Intl.NumberFormat('es-CO', { 
                    style: 'currency', 
                    currency: 'COP', 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
                const price = book.discountPrice && book.discountPrice < book.price 
                    ? priceFormatter.format(book.discountPrice) 
                    : priceFormatter.format(book.price);
                
                const description = `${book.author} - ${book.genre}. ${book.condition}. Precio: ${price}. ${book.description.substring(0, 120)}...`;
                
                // Actualizar t√≠tulo
                document.title = `${book.title} - El Rinc√≥n del Lector`;
                
                // Actualizar meta tags
                setMetaTag('description', description);
                setMetaTag('og:title', `${book.title} - El Rinc√≥n del Lector`);
                setMetaTag('og:description', description);
                setMetaTag('og:url', currentUrl);
                setMetaTag('og:image', imageSrc);
                setMetaTag('twitter:title', book.title);
                setMetaTag('twitter:description', description);
                setMetaTag('twitter:image', imageSrc);
            }
            
            function setMetaTag(property, content) {
                let meta = document.querySelector(`meta[property="${property}"]`);
                if (!meta) {
                    meta = document.querySelector(`meta[name="${property}"]`);
                }
                if (meta) {
                    meta.setAttribute('content', content);
                }
            }
            
            // Copiar al portapapeles
            function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => showNotification('¬°Enlace copiado al portapapeles!'))
                        .catch(() => fallbackCopy(text));
                } else {
                    fallbackCopy(text);
                }
            }
            
            function fallbackCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('¬°Enlace copiado!');
                } catch (err) {
                    showNotification('No se pudo copiar', true);
                }
                document.body.removeChild(textArea);
            }
            
            function showNotification(message, isError = false) {
                const notification = document.createElement('div');
                notification.className = `notification ${isError ? 'notification--error' : 'notification--success'}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.classList.add('visible'), 10);
                setTimeout(() => {
                    notification.classList.remove('visible');
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }
            
            // Compartir en Facebook
            function shareOnFacebook(url) {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                window.open(facebookUrl, 'facebook-share', 'width=600,height=400');
            }
            
            // Modal de imagen
            function setupImageModal() {
                const modal = document.getElementById('image-modal');
                const modalImage = modal.querySelector('.modal-image');
                const closeButton = modal.querySelector('.modal-close');
                
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'book-cover') {
                        modalImage.src = e.target.src;
                        modal.classList.add('visible');
                        document.body.classList.add('no-scroll');
                    }
                });
                
                closeButton.addEventListener('click', () => {
                    modal.classList.remove('visible');
                    document.body.classList.remove('no-scroll');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                        document.body.classList.remove('no-scroll');
                    }
                });
            }
            
            // Inicializar
            async function init() {
                const bookId = getBookIdFromURL();
                const container = document.getElementById('book-container');
                
                if (!bookId) {
                    container.innerHTML = '<div class="error-message">No se especific√≥ un libro. <a href="index.html">Volver a la tienda</a></div>';
                    return;
                }
                
                const books = await fetchBooks();
                
                if (!books) {
                    container.innerHTML = '<div class="error-message">Error al cargar los datos. <a href="index.html">Volver a la tienda</a></div>';
                    return;
                }
                
                const book = books.find(b => b.id === parseInt(bookId, 10));
                
                if (!book) {
                    container.innerHTML = '<div class="error-message">Libro no encontrado. <a href="index.html">Volver a la tienda</a></div>';
                    return;
                }
                
                // Renderizar el libro
                container.innerHTML = generateBookDetailHTML(book);
                updateMetaTags(book);
                
                // Event listeners
                const currentUrl = window.location.href;
                
                document.getElementById('copy-link-btn').addEventListener('click', () => {
                    copyToClipboard(currentUrl);
                });
                
                document.getElementById('share-facebook-btn').addEventListener('click', () => {
                    shareOnFacebook(currentUrl);
                });
                
                setupImageModal();
            }
            
            // Ejecutar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>